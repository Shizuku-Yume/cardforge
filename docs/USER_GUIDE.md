# CardForge 用户手册

本文档介绍 CardForge 的完整功能和操作方法。

---

## 目录

- [支持格式](#支持格式)
- [工作台](#工作台)
- [世界书编辑](#世界书编辑)
- [Quack 导入](#quack-导入)
- [AI 辅助](#ai-辅助)
- [快捷键](#快捷键)
- [常见问题](#常见问题)

---

## 支持格式

| 格式 | 读取 | 写入 | 说明 |
|------|:----:|:----:|------|
| CCv3 PNG | ✅ | ✅ | 推荐格式，完整元数据 |
| CCv2 PNG | ✅ | ✅ | 兼容旧版 SillyTavern |
| JSON | ✅ | ✅ | 纯数据格式，CCv3/CCv2 |
| JPG/WebP/GIF | ✅ | - | 仅作为卡面图片 |
| Quack | ✅ | - | 通过 API 或手动导入 |

### 基本流程

1. **上传卡片** - 拖拽或点击上传区域
2. **编辑内容** - 在各分区编辑器中修改
3. **导出卡片** - 点击"导出 PNG"按钮

---

## 工作台

工作台是 CardForge 的核心功能区。

### 上传卡片

- **拖拽上传**: 将 PNG/JSON 文件拖到左侧图片区域
- **点击上传**: 点击上传区域选择文件
- **更换图片**: 上传后点击"更换图片"可替换卡面

### 分区编辑器

| 分区 | 内容 |
|------|------|
| 基础信息 | 名称、创建者、版本、标签 |
| 描述 | 角色描述、人设、性格 |
| 消息 | 开场白、系统提示、备选开场白 |
| 系统设置 | 后置提示、创建者备注 |
| 高级设置 | 扩展字段、资产 |

### 自动保存

- 编辑时自动保存草稿到浏览器本地存储
- 刷新页面后会提示恢复草稿
- 导出成功后自动清除草稿

### Token 估算

- 左侧面板显示当前卡片的 Token 估算值
- 算法：中文字符 ÷ 0.7 + 非中文字符 ÷ 4
- 颜色提示：
  - 🟢 绿色：< 70% 上下文
  - 🟡 黄色：70% - 90%
  - 🔴 红色：> 90%

### 导出选项

| 操作 | 说明 |
|------|------|
| 导出 PNG | 将元数据注入到图片中（推荐） |
| 导出 JSON | 仅导出 JSON 数据 |

导出文件自动命名格式：`{角色名}_{日期}_{时间}.png`

---

## 世界书编辑

世界书（Lorebook）用于存储角色相关的背景设定。

### 条目管理

- **添加条目**: 点击"添加条目"按钮
- **删除条目**: 点击条目右上角的删除图标
- **复制条目**: 点击复制图标创建副本
- **拖拽排序**: 拖动条目左侧的把手调整顺序

### 条目字段

| 字段 | 说明 |
|------|------|
| 名称 | 条目标识名称 |
| 关键词 | 触发条目的关键词（逗号分隔） |
| 内容 | 条目正文内容 |
| 启用 | 是否激活该条目 |
| 常驻 | 始终插入上下文（无需触发） |
| 次要关键词 | 辅助触发词 |
| 优先级 | 数值越大优先级越高 |

### 导入/导出

| 操作 | 说明 |
|------|------|
| 导出世界书 | 导出为独立 JSON 文件 |
| 导入世界书 | 从 JSON 文件导入 |
| 替换模式 | 完全替换现有条目 |
| 合并模式 | 追加新条目，保留现有条目 |

---

## Quack 导入

从 Quack 平台导入角色卡。

### 方式一：API 模式（推荐）

1. 输入角色 ID 或完整 URL
2. 输入 Quack Cookie（见下方获取方法）
3. 选择导入模式和输出格式
4. 点击"开始导入"

### 方式二：手动 JSON 粘贴

当 API 模式不可用时（如 IP 被封禁），可使用手动模式：

1. 切换到"手动粘贴 JSON"模式
2. 在浏览器开发者工具中获取角色 JSON 数据
3. 粘贴到文本框
4. 点击"解析并导入"

### 获取 Quack Cookie

1. 登录 Quack 网站
2. 打开浏览器开发者工具（F12）
3. 切换到"网络"(Network) 标签
4. 刷新页面，点击任意请求
5. 在请求头中找到 `Cookie` 字段，复制完整内容

支持的 Cookie 格式：
- **Header 格式**: `key1=value1; key2=value2`
- **JSON 格式**: `[{"name":"key1","value":"value1"}]`
- **Netscape 格式**: 从 Cookie 导出插件获取

### 导入选项

| 选项 | 说明 |
|------|------|
| 完整卡片 | 导入角色信息 + 世界书 |
| 仅世界书 | 只导入世界书条目 |
| JSON 输出 | 导出为 JSON 文件 |
| PNG 输出 | 导出为带元数据的 PNG |

### ⚠️ 安全提示

- Cookie 仅在浏览器中使用，不会保存到服务器
- 频繁请求可能导致 IP 被封禁
- 建议使用手动模式作为备选方案

---

## AI 辅助

使用 AI 模型辅助创作角色卡。

### 配置 AI 服务

1. 进入 AI 辅助页面
2. 配置以下选项：

| 设置 | 说明 |
|------|------|
| API URL | AI 服务地址（OpenAI 兼容格式） |
| API Key | 服务密钥 |
| 使用代理 | 是否通过后端代理请求 |
| 模型 | 选择要使用的模型 |

3. 点击"测试连接"验证配置

### 支持的 AI 服务

| 服务 | API URL |
|------|---------|
| OpenAI | `https://api.openai.com/v1` |
| Anthropic | `https://api.anthropic.com/v1` |
| OpenRouter | `https://openrouter.ai/api/v1` |
| Google AI | `https://generativelanguage.googleapis.com/v1beta` |
| 本地服务 | `http://localhost:11434/v1` (Ollama) |

### 工作流

#### 一句话生成角色卡

输入简短描述，AI 自动生成完整角色卡。

示例输入：
> 一个性格高冷但内心温柔的猫娘女仆

#### 开场白裂变

基于现有开场白生成多个变体版本。

1. 输入或选择现有开场白
2. 设置裂变数量
3. 点击"生成裂变"

#### 卡片翻译

将角色卡翻译为其他语言。

1. 选择目标语言
2. 选择要翻译的字段
3. 点击"开始翻译"

#### 旧卡焕新

使用 AI 优化和扩写现有角色卡内容。

### 魔法棒按钮

在工作台的文本编辑器旁边，点击 ✨ 魔法棒按钮可快速调用 AI：

- **优化**: 改进文本表达
- **扩写**: 丰富内容细节
- **翻译**: 翻译为其他语言

---

## 快捷键

| 快捷键 | 功能 |
|--------|------|
| `Ctrl/Cmd + Z` | 撤销 |
| `Ctrl/Cmd + Y` | 重做 |
| `Ctrl/Cmd + Shift + Z` | 重做（Mac 习惯） |
| `Ctrl/Cmd + S` | 导出 PNG |

---

## 常见问题

### Q: 导入 PNG 后数据为空？

可能原因：
- PNG 文件不包含 `ccv3` 或 `chara` 元数据
- 元数据格式损坏

解决方案：尝试导入原始 JSON 文件。

### Q: Token 估算不准确？

Token 估算使用简化算法，与实际模型 tokenizer 存在差异。仅供参考。

### Q: Quack 导入失败？

可能原因：
- Cookie 过期或无效
- IP 被封禁
- 角色 ID 不存在

解决方案：
1. 重新获取 Cookie
2. 切换到手动 JSON 粘贴模式
3. 检查角色 ID 是否正确

### Q: AI 连接失败？

检查：
1. API URL 是否正确（需要完整路径如 `/v1`）
2. API Key 是否有效
3. 网络是否可访问目标服务
4. 如使用本地服务，确保"使用代理"已关闭

---

## 反馈与支持

如有问题或建议，请提交 Issue 到项目 GitHub 仓库。
