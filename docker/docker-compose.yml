# CardForge Docker Compose Configuration
# Usage: docker compose -f docker/docker-compose.yml up -d

services:
  cardforge:
    build:
      context: ..
      dockerfile: docker/Dockerfile
    container_name: cardforge
    restart: unless-stopped
    ports:
      - "${CARDFORGE_PORT:-8000}:8000"
    environment:
      # Application settings
      - CARDFORGE_APP_VERSION=${CARDFORGE_APP_VERSION:-0.1.0}
      - CARDFORGE_DEBUG=${CARDFORGE_DEBUG:-false}
      
      # File limits
      - CARDFORGE_MAX_UPLOAD_MB=${CARDFORGE_MAX_UPLOAD_MB:-20}
      
      # HTTP settings
      - CARDFORGE_HTTP_TIMEOUT=${CARDFORGE_HTTP_TIMEOUT:-30}
      
      # Proxy settings
      - CARDFORGE_PROXY_ENABLED_DEFAULT=${CARDFORGE_PROXY_ENABLED_DEFAULT:-false}
      - CARDFORGE_PROXY_ALLOW_LOCALHOST=${CARDFORGE_PROXY_ALLOW_LOCALHOST:-false}
      
      # Rate limiting
      - CARDFORGE_RATE_LIMIT_REQUESTS=${CARDFORGE_RATE_LIMIT_REQUESTS:-10}
      - CARDFORGE_RATE_LIMIT_WINDOW_SECONDS=${CARDFORGE_RATE_LIMIT_WINDOW_SECONDS:-60}
      
      # Logging
      - CARDFORGE_LOG_LEVEL=${CARDFORGE_LOG_LEVEL:-INFO}
      - CARDFORGE_LOG_REDACT=${CARDFORGE_LOG_REDACT:-true}
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8000/api/health')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    deploy:
      resources:
        limits:
          cpus: "2"
          memory: 512M
        reservations:
          cpus: "0.25"
          memory: 128M
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

# Optional: Add nginx reverse proxy for production
# Uncomment below if you need nginx in front

#   nginx:
#     image: nginx:alpine
#     container_name: cardforge-nginx
#     restart: unless-stopped
#     ports:
#       - "80:80"
#       - "443:443"
#     volumes:
#       - ./nginx.conf:/etc/nginx/nginx.conf:ro
#       - ./certs:/etc/nginx/certs:ro
#     depends_on:
#       - cardforge
